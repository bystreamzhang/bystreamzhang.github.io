---
title: Balloon-ZNS优化记录
date: 2025-02-28 18:40:39
tags:
    - FEMU
    - ZNS
    - SSD
    - Balloon-ZNS
categories: Study
---

# 说明

记录对Balloon-ZNS的优化思路和实现.

## 思路1 不同大小zone

考虑默认让超级块和额外子超级块共存, slot就存放在超级块, 然后另外将一些超级块分为小的额外子超级块来存放残量. 

zwl师姐建议:


> 这个方法的本质是让zns支持多种并行度的zone。这常见于讨论大zone和小zone的工作中。例如，大zone 2GB，小zone128MB。大zone占据一个superblock，小zone只在一小部分channel上占据一个子superblock。
这样不同规格的zone的数量只能在命名空间初始化时就规划好，初始化完成后就不能再更改了。比如说，我们在femu的代码里就写好，占据superblock的zone有x个，占据sub-superblock的zone有y个。
然后编译启动femu，进去之后那个设备中的zone就已经按照我们规划的固定好，不能再更改。（关于这个问题，我放了一些论文在下面，你可以参考其中关于大zone小zone的部分。）
那么此时有一个问题，我们应该预备多少占据superblock的zone来存储slot？又预备多少sub-superblock的zone来存储residue？
如果这两者的zone不够，我们应该如何处理？所以我认为可以将这个当成一个潜在的优化方向

这个工作FlexZNS应该做过, 我先学习一下(见*ZNS-SSD-学习记录*).

主要有几个问题要考虑:

- FlexZNS是如何允许自行设置zone的大小的, 如何解决奇偶校验空间的变化问题
- 如何使用户不主动往存放残量的小zone写入数据
- 如何让用户自行设置大zone和小zone的具体大小和数量
- 如果存放残量的zone满了应该怎么办

## 思路2 递增槽大小分析窗口

毕设的工作。

核心思路是根据输入区域的第一个逻辑页压缩后的槽大小向上按256B对齐计算出第一个分析窗口的槽大小，之后这个分析窗口就一直使用，直到遇到一个逻辑页压缩后槽大小大于此大小的情况，此时开辟新的分析窗口并按类似方法计算出新分析窗口的槽大小。这样就可以保证分析窗口的槽大小一定大于其中每个压缩后逻辑页的大小，并且分析窗口的总数量是可控的，因为分析窗口的槽大小只会递增，极限情况下也只有逻辑页大小（如4KB）除以256B种可能。事实上槽大小的可能性会很少，因为数据本身的压缩率变化波动并不会特别大。

示意图如下：

![递增槽大小分析窗口示意图](IncSlotSize.drawio.png)

顺便把毕设的一些自己做的图片也记录一下吧。

下面是系统架构图，从ZNS SSD论文提取过来然后加入FEMU、QEMU和QAT部分。

![系统架构图](Structure-bishe.drawio.png)


