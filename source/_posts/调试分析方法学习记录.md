---
title: 调试分析方法学习记录
date: 2025-03-03 21:32:39
tags:
    - Debug
    - GDB
    - QEMU
categories: Study
---

# 说明

记录各种调试分析方法.

具体有以下类型:

- 程序调试
- 程序分析
- 代码分析

## 核心理念

我觉得包括我在内的很多中国计算机学生在本科阶段对于调试方法肯定是没太多认识的, 因为课程老师也不太强调,
我们也很少接触复杂到必须使用除了printf以外的调试方法的项目.

但是好的调试方法肯定是很有用的, printf不可能一招吃遍天.

另外, 代码和程序的分析方法也很重要.

拿到别人的一个项目代码, 我不想每次都自行梳理整个项目的框架, 思考每个函数的重要性, 思考函数间的调用关系.
很多信息是可以用工具来辅助获取的.

## GDB

[Debugging with GDB](https://sourceware.org/gdb/current/onlinedocs/gdb.html/) 网页文档, 非常值得阅读.

## Perf

Ubuntu可以通过`sudo apt install linux-tools-common linux-tools-$(uname -r)`安装perf.

通过`perf -h`就可查看文档.

进程查找：使用`ps -ef | grep qemu`查找包括qemu的进程, 第一列是UID, 第二列是PID, 第三列是PPID即父进程号.

## FlameGraph

[FlameGraph github](https://github.com/brendangregg/FlameGraph?tab=readme-ov-file)

[火焰图生成与分析](https://zhuanlan.zhihu.com/p/402188023) 不错的知乎专栏可供参考
[如何读懂火焰图？](https://www.ruanyifeng.com/blog/2017/09/flame-graph.html) 普及性介绍

火焰图是基于 perf 结果产生的 SVG 图片, 用来展示 CPU 的调用栈. 特点就是生动形象, 信息丰富.

火焰图测试时，必须先运行目标程序，然后用`perf record`进行数据采样，只有程序在运行时才会生成有意义的数据。

工具安装:

Ubuntu:

```bash
# 安装 perf 和 FlameGraph 脚本
sudo apt install linux-tools-common linux-tools-$(uname -r)
git clone https://github.com/brendangregg/FlameGraph.git
export PATH=$PATH:~/FlameGraph  # 将脚本加入 PATH. 这样后面可以直接用其中的软件
```

查看帮助: `./FlameGraph/flamegraph.pl -h`

可以用以下的流程生成:

```bash
ps -ef | grep qemu # 找到进程PID(第二列)
# 采集 CPU 调用栈数据（采样频率 99Hz，持续 30秒）, 自行填写PID
sudo perf record -F 99 -p PID -g --call-graph dwarf sleep 30
# 生成原始数据文件（perf.data）
sudo chmod 644 perf.data  # 确保有读取权限
# 提取符号信息
perf script > out.stack
# 折叠调用栈并生成 SVG
stackcollapse-perf.pl out.stack | flamegraph.pl > graph.svg
```

E: `perf record`表示采集系统事件; `perf script` 可以解析采集数据并生成调用栈;
`stackcollapse-perf.pl`工具将调用栈的符号折叠; `flamegraph.pl`可以用折叠后的数据生成svg图.

后两步是火焰图工具的功能. 每一步的具体原理不知道也没关系, 不影响生成火焰图.

生成svg文件后, 如果是用vscode远程连接服务器, 直接在资源管理器右键下载svg文件即可在本机浏览. vscode也有svg插件可以直接浏览svg文件.

### 注意事项

- 如果程序没有运行, 就无法采集数据, perf record 会报错或者采样到无用的数据.
- 对短时间运行的程序, 可以用 sleep 让它保持运行, 例如：
  
```bash
./my_program & sleep 30
sudo perf record -F 99 -p $(pgrep my_program) -g -- sleep 30
```

- 对批处理程序，可以用`perf record --`直接运行它：
  
```bash
sudo perf record -F 99 -g -- ./my_program
```

## eBPF/BCC

## Trace Compass

## Understand

## 实例


### qemu调试

qemu可以用gdb调试的. 运行命令最前面加上 `gdb --args`. 进去之后会显示gdb, 输入`handle SIGUSR1 nostop`(如果不这样, 会一直出现此信号影响调试), 然后输入run.

我目前对qemu使用gdb有以下用途:

- 如果存在一些error, 使用gdb运行可能可以显示更丰富的报错信息.
- 输入诸如`b zns_zone_mgmt_send`的命令可以添加断点. 后面做测试遇到断点会自动停下, 用s可以单步调试用n可以逐过程调试. 有一次就是利用这个方法, 我发现switch语句中case外的语句不会执行


火焰图也没问题. 在宿主机(启动qemu的主机), 找到启动后的qemu的PID.
注意, `ps -ef | grep qemu`可能找到两个相关进程, 可以看第四列的CPU使用率和第七列的运行时间, 使用率高的才应该是是实际执行 QEMU 虚拟机的进程.
另一个可能是sudo进程或启动 QEMU 的管理进程.

